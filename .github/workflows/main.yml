name: main

on:
  push:
  pull_request:
    branches:
      - master

jobs:
  # Enforce the standard of g_malloc instead of malloc in the project
  enforce-g_malloc:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        # Clone the whole branch, we have to fetch tags later
        fetch-depth: 0

    - name: enforce-g_malloc
      run: "! git grep -P '(?<!g_)malloc' ':!.valgrind.suppressions' ':!.github/workflows/main.yml'"

  build:
    strategy:
      matrix:
        CC:
          - clang
          - gcc
        distro:
          # - alpine
          - archlinux
          - debian-bookworm
          - debian-bullseye
          - debian-buster
          - fedora
          - ubuntu-focal
          - ubuntu-jammy

    env:
      CC: ${{ matrix.CC }}
      EXTRA_CFLAGS: "-Werror ${{ (matrix.distro == 'debian-bookworm' || matrix.distro == 'ubuntu-jammy') && '-gdwarf-4' || ' '}}"
    steps:
    - uses: actions/checkout@v4
      with:
        # Clone the whole branch, we have to fetch tags later
        fetch-depth: 0

    # Fetch tags to determine proper version number inside git
    - name: fetch tags
      run: git fetch --tags

    - name: build
      run: make -j all dunstify test/test

    - name: test
      run: make -j test

    - name: installation
      run: ./test/test-install.sh

    - name: valgrind memleaks
      run: |
        make clean
        make -j test-valgrind

    - name: coverage
      run: |
        make clean
        make -j test-coverage

    - name: Generate coverage report
      run: lcov -c -d . -o lcov.info
      if: "matrix.CC == 'gcc'"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        flags: unittests
        name: ${{ matrix.distro }}-${{ matrix.CC }}
        fail_ci_if_error: true
      if: "matrix.CC == 'gcc'"

    runs-on: ubuntu-latest
    container:
      image: ghcr.io/dunst-project/docker-images:${{ matrix.distro }}
      # options: --user 1001

  doxygen:
    strategy:
      matrix:
        distro:
          - misc-doxygen

    steps:
    - uses: actions/checkout@v4
      with:
        # Clone the whole branch, we have to fetch tags later
        fetch-depth: 0

    - name: doxygen
      run: make -j doc-doxygen

    runs-on: ubuntu-latest
    container:
      image: ghcr.io/dunst-project/docker-images:${{ matrix.distro }}
